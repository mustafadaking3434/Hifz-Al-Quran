<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>ÿ≠ŸÅÿ∏ ÿßŸÑŸÇÿ±ÿ¢ŸÜ - Hifz Al-Quran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&family=Scheherazade+New&display=swap');
    
    :root {
      --primary-green: #1b5e20;
      --accent-gold: #d4af37;
      --background-light: #f9f9f7;
      --background-dark: #0d1b0f;
      --text-dark: #263238;
      --text-light: #f0f0e9;
      --tajweed-madd: #f39c12;
      --tajweed-ghunnah: #8e44ad;
      --tajweed-idgham: #27ae60;
      --border-radius: 12px;
      --shadow: rgba(27, 94, 32, 0.25);
      --transition-speed: 0.3s;
    }
    
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: var(--background-light);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background-image:
        radial-gradient(circle at top left, rgba(212,175,55,0.1) 1px, transparent 2px),
        radial-gradient(circle at bottom right, rgba(27,94,32,0.1) 1px, transparent 2px);
      background-size: 30px 30px;
      background-repeat: repeat;
    }
    
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--border-radius);
      padding: 12px 22px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-light);
      background: var(--primary-green);
      box-shadow: 0 4px 12px var(--shadow);
      transition: background var(--transition-speed), transform var(--transition-speed);
      user-select: none;
      margin: 6px 8px 10px 0;
      min-width: 140px;
      text-align: center;
    }
    button:hover, button:focus {
      background: var(--accent-gold);
      color: var(--text-dark);
      transform: translateY(-2px);
      outline: none;
      box-shadow: 0 6px 18px rgba(212,175,55,0.5);
    }
    button.secondary {
      background: #556b2f;
      color: var(--text-light);
      box-shadow: 0 4px 10px rgba(27, 94, 32, 0.15);
    }
    button.secondary:hover, button.secondary:focus {
      background: #a99a32;
      color: var(--text-dark);
      box-shadow: 0 5px 14px rgba(212,175,55,0.4);
    }
    
    h1, h2 {
      font-family: 'Scheherazade New', serif;
      font-weight: 700;
      margin-bottom: 0.25rem;
      color: var(--primary-green);
      user-select: none;
    }
    h1 {
      font-size: 3rem;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 2rem;
      margin-top: 0;
    }
    
    select, input[type=number] {
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      border-radius: var(--border-radius);
      border: 1.5px solid var(--primary-green);
      padding: 8px 12px;
      margin: 0 10px 12px 0;
      transition: border-color 0.3s;
      min-width: 80px;
      color: var(--text-dark);
    }
    select:focus, input[type=number]:focus {
      border-color: var(--accent-gold);
      outline: none;
    }
    
    label {
      font-weight: 600;
      color: var(--primary-green);
      user-select: none;
    }
    
    .screen {
      display: none;
      width: 100%;
      max-width: 720px;
      background: white;
      box-shadow: 0 4px 25px var(--shadow);
      border-radius: var(--border-radius);
      padding: 1.5rem 2rem 2rem 2rem;
      margin-bottom: 2rem;
    }
    .screen.active {
      display: block;
    }
    
    /* Start Screen */
    #start {
      text-align: center;
      background: linear-gradient(135deg, #eafaf1, #d4e9d3);
      border: 2px solid var(--primary-green);
      user-select: none;
    }
    #start h1 {
      color: var(--primary-green);
    }
    #start .ayah {
      font-family: 'Scheherazade New', serif;
      font-size: 1.6rem;
      font-style: italic;
      margin-top: 1.2rem;
      color: #336633;
      user-select: text;
    }
    
    /* Menu */
    #menuTitle {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--primary-green);
    }
    #surahList, #hifzSurahList {
      max-height: 400px;
      overflow-y: auto;
      border: 1.5px solid var(--primary-green);
      border-radius: var(--border-radius);
      background: #f4f9f4;
      padding: 0.5rem 0;
      user-select: none;
    }
    .surahItem, .hifzSurahItem {
      padding: 12px 18px;
      margin: 6px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-green);
      transition: background-color 0.3s, color 0.3s;
      user-select: none;
      text-align: left;
    }
    .surahItem:hover, .hifzSurahItem:hover,
    .hifzSurahItem.selected {
      background-color: var(--primary-green);
      color: var(--text-light);
      box-shadow: 0 4px 14px var(--shadow);
    }
    
    /* Verses */
    #verses {
      margin-top: 1.2rem;
      user-select: text;
    }
    .verse {
      position: relative;
      padding-left: 38px;
      margin-bottom: 1.8rem;
      border-bottom: 1px dotted var(--primary-green);
      padding-bottom: 0.6rem;
      font-size: 1.3rem;
    }
    .verse:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .verse-number {
      position: absolute;
      left: 10px;
      top: 0;
      font-weight: 700;
      font-size: 1rem;
      color: var(--accent-gold);
      user-select: none;
      font-family: 'Scheherazade New', serif;
    }
    .arabic {
      font-family: 'Scheherazade New', serif;
      font-size: 2.4rem;
      direction: rtl;
      text-align: right;
      color: var(--primary-green);
      line-height: 1.4;
      user-select: text;
    }
    .translation {
      font-family: 'Cairo', sans-serif;
      font-size: 1.05rem;
      color: #3c4d2e;
      margin-top: 0.25rem;
      user-select: text;
      line-height: 1.5;
    }
    
    /* Tajweed coloring (subtle) */
    .arabic span.madd {
      color: var(--tajweed-madd);
      font-weight: 900;
    }
    .arabic span.ghunnah {
      color: var(--tajweed-ghunnah);
      font-weight: 900;
    }
    .arabic span.idgham {
      color: var(--tajweed-idgham);
      font-weight: 900;
    }
    
    /* Bismillah styling */
    .bismillah {
      font-size: 2.6rem;
      font-weight: 700;
      text-align: center;
      padding: 1rem 0 2rem 0;
      color: var(--accent-gold);
      font-family: 'Scheherazade New', serif;
      user-select: text;
      text-shadow: 1px 1px 5px rgba(212,175,55,0.6);
    }
    
    /* Hifz Test */
    #hifzTest {
      user-select: none;
      color: var(--text-dark);
    }
    #hifzTest label {
      user-select: none;
    }
    #hifzControls {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }
    #recordingStatus {
      margin-top: 0.75rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-green);
      min-height: 24px;
      text-align: center;
    }
    #hifzFeedback {
      margin-top: 1rem;
      font-weight: 600;
      font-size: 1.2rem;
      min-height: 40px;
      white-space: pre-wrap;
      color: #b22;
      user-select: text;
      text-align: center;
    }
    
    /* Inputs and selects inline on mobile */
    @media (max-width: 480px) {
      #hifzControls {
        flex-direction: column;
      }
      select, input[type=number] {
        min-width: 100%;
      }
      button {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>

<!-- START SCREEN -->
<div id="start" class="screen active" role="main" aria-label="Start Screen">
  <h1>ÿ≠ŸÅÿ∏ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</h1>
  <h2>Hifz Al-Quran</h2>
  <div class="ayah" lang="ar">‚ÄúŸàŸéŸÑŸéŸÇŸéÿØŸí ŸäŸéÿ≥ŸëŸéÿ±ŸíŸÜŸéÿß ÿßŸÑŸíŸÇŸèÿ±Ÿíÿ¢ŸÜŸé ŸÑŸêŸÑÿ∞ŸëŸêŸÉŸíÿ±Ÿê‚Äù ‚Äî Ÿ•Ÿ§:Ÿ°Ÿß</div>
  <button class="gold" id="startJourneyBtn" aria-label="Begin the journey button">Begin the Journey</button>
  <button class="gold" id="openHifzTestBtn" aria-label="Open hifz test button" style="margin-left:10px;">Hifz Test</button>
  <br />
  <button class="secondary" id="toggleDarkBtn" aria-label="Toggle dark mode">üåô Toggle Dark Mode</button>
  <br /><br />
  <label for="languageSelect" style="font-weight:bold; font-size:16px;">Language / ÿßŸÑŸÑÿ∫ÿ©:</label>
  <select id="languageSelect" aria-label="Select Language">
    <option value="en">English</option>
    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
  </select>
</div>

<!-- MENU -->
<div id="menu" class="screen" role="main" aria-label="Surah selection menu">
  <h2 id="menuTitle">Select Surah</h2>
  <button class="secondary" id="menuToggleDark" aria-label="Toggle dark mode">üåô Night Mode</button>
  <br /><br />
  <div id="surahList" role="list" tabindex="0" aria-label="List of Surahs"></div>
  <br />
  <button id="menuBackBtn" class="secondary" aria-label="Back to start">‚Üê Back to Start</button>
</div>

<!-- SURAH VIEW -->
<div id="surahView" class="screen" role="main" aria-label="Surah viewing screen">
  <button class="secondary" id="surahBackBtn" aria-label="Back to surah list">‚Üê Back</button>
  <h2 id="surahTitle"></h2>

  <button id="toggleTajweedBtn" aria-label="Toggle Tajweed coloring">Enable Tajweed</button>
  <button id="playSurahBtn" aria-label="Play Surah audio">‚ñ∂ Play Surah</button>
  <select id="reciterSelect" aria-label="Select Reciter" style="margin-left:10px;">
    <option value="ar.alafasy">Mishary Alafasy</option>
    <option value="ar.abdulbasitmurattal">Abdul Basit</option>
    <option value="ar.husary">Al-Husary</option>
    <option value="ar.minshawi">Minshawi</option>
    <option value="ar.shaatree">Shaatree</option>
    <option value="ar.sudanese">Sudanese</option>
    <option value="ar.muhammadayyoub">Muhammad Ayyoub</option>
  </select>

  <div id="verses"></div>
</div>

<!-- HIFZ TEST -->
<div id="hifzTest" class="screen" role="main" aria-label="Hifz test screen" aria-live="polite">
  <h2 id="hifzTitle">Hifz Test</h2>
  <div id="hifzSurahList" role="listbox" tabindex="0" aria-label="Select Surah for Hifz Test"></div>
  <div style="margin-top:10px; text-align: center;">
    <label for="fromAyahInput" id="fromAyahLabel">From Ayah:</label>
    <input type="number" id="fromAyahInput" min="1" value="1" aria-describedby="fromAyahLabel" />
    <label for="toAyahInput" id="toAyahLabel" style="margin-left:15px;">To Ayah:</label>
    <input type="number" id="toAyahInput" min="1" value="1" aria-describedby="toAyahLabel" />
  </div>

  <div id="hifzControls" style="margin-top:15px; justify-content:center;">
    <button id="loadSurahBtn">Load Surah</button>
    <button id="startRecitationBtn" disabled>Start Recording</button>
    <button id="stopRecitationBtn" style="display:none;">Stop Recording</button>
  </div>

  <div id="recordingStatus"></div>
  <div id="hifzFeedback"></div>
  <button id="hifzBackBtn" class="secondary" style="margin-top:20px;">‚Üê Back to Start</button>
</div>

<script>
  // --- Global variables and constants ---
  let tajweedEnabled = false;
  let currentSurahId = null;
  let currentSurahName = '';
  let currentSurahArabicName = '';
  let versesData = [];
  let reciter = 'ar.alafasy';
  let audioPlayer = null;
  let isDarkMode = false;

  // Language support
  const texts = {
    en: {
      startJourney: 'Begin the Journey',
      hifzTest: 'Hifz Test',
      selectSurah: 'Select Surah',
      loading: 'Loading‚Ä¶',
      loadError: 'Error loading surah. Please try again.',
      invalidRange: 'Invalid Ayah range.',
      recording: 'Recording...',
      stopped: 'Recording stopped.',
      correct: '‚úÖ Correct! Well done.',
      incorrect: '‚ùå Some mistakes found in your recitation:\n',
      notSupported: 'Speech recognition not supported in this browser.',
      selectSurahHifz: 'Select Surah for Hifz Test',
      fromAyah: 'From Ayah:',
      toAyah: 'To Ayah:',
      loadSurah: 'Load Surah',
      startRecording: 'Start Recording',
      stopRecording: 'Stop Recording',
      back: '‚Üê Back to Start',
      toggleTajweed: 'Toggle Tajweed',
      playSurah: '‚ñ∂ Play Surah',
      nightMode: 'üåô Night Mode',
      surahViewTitle: 'Surah View',
      hifzTitle: 'Hifz Test',
      recordingError: 'Error during recording.',
      pleaseLoadSurah: 'Please load a surah first.'
    },
    ar: {
      startJourney: 'ÿßÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©',
      hifzTest: 'ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏',
      selectSurah: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ≥Ÿàÿ±ÿ©',
      loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ‚Ä¶',
      loadError: 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.',
      invalidRange: 'ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ¢Ÿäÿßÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.',
      recording: 'Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...',
      stopped: 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ.',
      correct: '‚úÖ ÿµÿ≠Ÿäÿ≠! ÿ£ÿ≠ÿ≥ŸÜÿ™.',
      incorrect: '‚ùå ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸÅŸä ÿ™ŸÑÿßŸàÿ™ŸÉ:\n',
      notSupported: 'ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÉŸÑÿßŸÖ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.',
      selectSurahHifz: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿ≥Ÿàÿ±ÿ© ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏',
      fromAyah: 'ŸÖŸÜ ÿßŸÑÿ¢Ÿäÿ©:',
      toAyah: 'ÿ•ŸÑŸâ ÿßŸÑÿ¢Ÿäÿ©:',
      loadSurah: 'ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©',
      startRecording: 'ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ',
      stopRecording: 'ÿ£ŸàŸÇŸÅ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ',
      back: '‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ®ÿØÿßŸäÿ©',
      toggleTajweed: 'ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ™ÿ¨ŸàŸäÿØ',
      playSurah: '‚ñ∂ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©',
      nightMode: 'üåô ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä',
      surahViewTitle: 'ÿπÿ±ÿ∂ ÿßŸÑÿ≥Ÿàÿ±ÿ©',
      hifzTitle: 'ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏',
      recordingError: 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ.',
      pleaseLoadSurah: 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥Ÿàÿ±ÿ© ÿ£ŸàŸÑÿßŸã.'
    }
  };
  let currentLang = 'en';

  // DOM elements
  const startScreen = document.getElementById('start');
  const menuScreen = document.getElementById('menu');
  const surahViewScreen = document.getElementById('surahView');
  const hifzTestScreen = document.getElementById('hifzTest');

  const startJourneyBtn = document.getElementById('startJourneyBtn');
  const openHifzTestBtn = document.getElementById('openHifzTestBtn');
  const toggleDarkBtn = document.getElementById('toggleDarkBtn');
  const menuToggleDarkBtn = document.getElementById('menuToggleDark');
  const menuBackBtn = document.getElementById('menuBackBtn');
  const surahBackBtn = document.getElementById('surahBackBtn');
  const toggleTajweedBtn = document.getElementById('toggleTajweedBtn');
  const playSurahBtn = document.getElementById('playSurahBtn');
  const reciterSelect = document.getElementById('reciterSelect');
  const languageSelect = document.getElementById('languageSelect');

  const surahListDiv = document.getElementById('surahList');
  const versesDiv = document.getElementById('verses');
  const surahTitle = document.getElementById('surahTitle');

  const hifzSurahList = document.getElementById('hifzSurahList');
  const fromAyahInput = document.getElementById('fromAyahInput');
  const toAyahInput = document.getElementById('toAyahInput');
  const loadSurahBtn = document.getElementById('loadSurahBtn');
  const startRecitationBtn = document.getElementById('startRecitationBtn');
  const stopRecitationBtn = document.getElementById('stopRecitationBtn');
  const hifzBackBtn = document.getElementById('hifzBackBtn');
  const recordingStatus = document.getElementById('recordingStatus');
  const hifzFeedback = document.getElementById('hifzFeedback');
  const hifzTitle = document.getElementById('hifzTitle');

  let allSurahs = [];
  let recognition = null;
  let recognizing = false;
  let expectedText = '';
  let hifzSurahVerses = [];

  // Show/hide screens
  function showScreen(screen) {
    [startScreen, menuScreen, surahViewScreen, hifzTestScreen].forEach(s => s.classList.remove('active'));
    screen.classList.add('active');
  }

  // Toggle Dark mode
  function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    if(isDarkMode) {
      document.body.style.background = '#0d1b0f';
      document.body.style.color = 'var(--text-light)';
    } else {
      document.body.style.background = 'var(--background-light)';
      document.body.style.color = 'var(--text-dark)';
    }
  }

  // Update UI language texts
  function updateLanguageUI() {
    startJourneyBtn.textContent = texts[currentLang].startJourney;
    openHifzTestBtn.textContent = texts[currentLang].hifzTest;
    toggleDarkBtn.textContent = texts[currentLang].nightMode;
    menuToggleDarkBtn.textContent = texts[currentLang].nightMode;
    menuBackBtn.textContent = texts[currentLang].back;
    surahBackBtn.textContent = texts[currentLang].back;
    toggleTajweedBtn.textContent = tajweedEnabled ? (currentLang==='ar'? 'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ¨ŸàŸäÿØ' : 'Disable Tajweed') : texts[currentLang].toggleTajweed;
    playSurahBtn.textContent = texts[currentLang].playSurah;
    loadSurahBtn.textContent = texts[currentLang].loadSurah;
    startRecitationBtn.textContent = texts[currentLang].startRecording;
    stopRecitationBtn.textContent = texts[currentLang].stopRecording;
    hifzBackBtn.textContent = texts[currentLang].back;
    hifzTitle.textContent = texts[currentLang].hifzTitle;

    document.getElementById('fromAyahLabel').textContent = texts[currentLang].fromAyah;
    document.getElementById('toAyahLabel').textContent = texts[currentLang].toAyah;
  }

  // Load list of all surahs from API
  async function loadAllSurahs() {
    try {
      const res = await fetch('https://api.alquran.cloud/v1/surah');
      const data = await res.json();
      if(data.code !== 200) throw new Error('API error');
      allSurahs = data.data;
      renderSurahList();
      renderHifzSurahList();
    } catch {
      alert(texts[currentLang].loadError);
    }
  }

  // Render Surah list for menu
  function renderSurahList() {
    surahListDiv.innerHTML = '';
    allSurahs.forEach(surah => {
      const div = document.createElement('div');
      div.className = 'surahItem';
      div.textContent = currentLang === 'ar'
        ? `${surah.number}. ${surah.name}`
        : `${surah.number}. ${surah.englishName}`;
      div.tabIndex = 0;
      div.setAttribute('role','button');
      div.onclick = () => openSurahView(surah.number, surah.englishName, surah.name);
      div.onkeydown = (e) => { if(e.key === 'Enter') div.click(); };
      surahListDiv.appendChild(div);
    });
  }

  // Render Surah list for Hifz test
  function renderHifzSurahList() {
    hifzSurahList.innerHTML = '';
    allSurahs.forEach(surah => {
      const div = document.createElement('div');
      div.className = 'hifzSurahItem';
      div.textContent = currentLang === 'ar'
        ? `${surah.number}. ${surah.name}`
        : `${surah.number}. ${surah.englishName}`;
      div.tabIndex = 0;
      div.setAttribute('role','option');
      div.onclick = () => {
        [...hifzSurahList.children].forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        currentSurahId = surah.number;
        currentSurahName = surah.englishName;
        currentSurahArabicName = surah.name;
        fromAyahInput.value = 1;
        toAyahInput.value = 1;
        fromAyahInput.min = 1;
        toAyahInput.min = 1;
        loadSurahVersesForHifz(surah.number);
      };
      div.onkeydown = (e) => { if(e.key === 'Enter') div.click(); };
      hifzSurahList.appendChild(div);
    });
  }

  // Open surah view for reading and listening
  async function openSurahView(num, en, ar) {
    showScreen(surahViewScreen);
    currentSurahId = num;
    currentSurahName = en;
    currentSurahArabicName = ar;
    surahTitle.textContent = currentLang === 'ar' ? `${num}. ${ar}` : `${num}. ${en}`;
    versesDiv.innerHTML = texts[currentLang].loading;
    try {
      const [arRes, enRes] = await Promise.all([
        fetch(`https://api.alquran.cloud/v1/surah/${num}`),
        fetch(`https://api.alquran.cloud/v1/surah/${num}/en.asad`)
      ]);
      const arData = await arRes.json();
      const enData = await enRes.json();
      if(arData.code !== 200 || enData.code !== 200) throw new Error('API error');
      const ayahs = arData.data.ayahs;
      const translations = enData.data.ayahs;

      versesData = ayahs.map((ayah, idx) => ({
        number: ayah.numberInSurah,
        arabic: ayah.text,
        translation: translations[idx].text
      }));

      renderVerses();
    } catch {
      versesDiv.innerHTML = `<p style="color:red;">${texts[currentLang].loadError}</p>`;
    }
  }

  // Render verses with Tajweed and numbering (excluding Bismillah)
  function renderVerses() {
    versesDiv.innerHTML = '';
    let startNumberingIndex = 0;

    // Detect and separate Bismillah ar-Rahman ar-Raheem if first verse contains it
    if(versesData.length > 0 && versesData[0].arabic.includes('ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ')) {
      // Show Bismillah separately, no number
      const bismillahDiv = document.createElement('div');
      bismillahDiv.className = 'bismillah';
      bismillahDiv.innerHTML = tajweedEnabled ? applyTajweed(versesData[0].arabic) : versesData[0].arabic;
      versesDiv.appendChild(bismillahDiv);
      startNumberingIndex = 1; // Start numbering from second verse
    }

    for(let i = startNumberingIndex; i < versesData.length; i++) {
      const v = versesData[i];
      const verseDiv = document.createElement('div');
      verseDiv.className = 'verse';
      verseDiv.innerHTML = `
        <div class="verse-number">${v.number}</div>
        <div class="arabic">${tajweedEnabled ? applyTajweed(v.arabic) : v.arabic}</div>
        <div class="translation">${v.translation}</div>
      `;
      versesDiv.appendChild(verseDiv);
    }
  }

  // Simple Tajweed coloring function for demonstration
  function applyTajweed(text) {
    return text
      .replace(/(ŸÖ{2,})/g, '<span class="ghunnah">$1</span>') // ghunnah example (meem)
      .replace(/(ŸÜ{2,})/g, '<span class="idgham">$1</span>')  // idgham example (noon)
      .replace(/(ŸÄŸì)/g, '<span class="madd">ŸÄŸì</span>');     // madd symbol
  }

  // Play Surah audio
  function playSurahAudio() {
    if(audioPlayer) {
      audioPlayer.pause();
      audioPlayer = null;
    }
    audioPlayer = new Audio(`https://cdn.islamic.network/quran/audio-surah/128/${reciter}/${currentSurahId}.mp3`);
    audioPlayer.play();
  }

  // Speech recognition setup for Hifz test
  function setupRecognition() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert(texts[currentLang].notSupported);
      return null;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = currentLang === 'ar' ? 'ar-SA' : 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      recognizing = true;
      recordingStatus.textContent = texts[currentLang].recording;
      hifzFeedback.textContent = '';
    };

    recognition.onerror = (event) => {
      recognizing = false;
      recordingStatus.textContent = '';
      hifzFeedback.textContent = texts[currentLang].recordingError + ` (${event.error})`;
      startRecitationBtn.disabled = false;
      stopRecitationBtn.style.display = 'none';
    };

    recognition.onend = () => {
      recognizing = false;
      recordingStatus.textContent = texts[currentLang].stopped;
      startRecitationBtn.disabled = false;
      stopRecitationBtn.style.display = 'none';
    };

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      analyzeRecitation(transcript);
    };
  }

  // Normalize Arabic text for comparison
  function normalizeArabic(text) {
    return text
      .replace(/[\u064B-\u065F]/g, '') // remove tashkeel
      .replace(/\s+/g, '') // remove spaces
      .replace(/ŸÄ/g, '') // remove tatweel
      .trim();
  }

  // Compare expected and recognized text, highlight mistakes
  function compareTexts(expected, actual) {
    const expectedWords = expected.split(/\s+/);
    const actualWords = actual.split(/\s+/);

    let mistakes = [];

    expectedWords.forEach((word, idx) => {
      if (!actualWords[idx] || normalizeArabic(word) !== normalizeArabic(actualWords[idx])) {
        mistakes.push(word);
      }
    });

    return mistakes;
  }

  // Analyze recitation and show feedback
  function analyzeRecitation(userText) {
    if(!expectedText) return;

    const normExpected = normalizeArabic(expectedText);
    const normUser = normalizeArabic(userText);

    if(normExpected === normUser) {
      hifzFeedback.style.color = 'green';
      hifzFeedback.textContent = texts[currentLang].correct;
    } else {
      hifzFeedback.style.color = '#b22';
      const mistakes = compareTexts(expectedText, userText);
      hifzFeedback.textContent = texts[currentLang].incorrect + mistakes.join(' ');
    }
  }

  // Load surah verses for Hifz test and set max ayah range
  async function loadSurahVersesForHifz(surahNumber) {
    hifzFeedback.textContent = '';
    recordingStatus.textContent = '';
    fromAyahInput.value = 1;
    toAyahInput.value = 1;

    try {
      const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
      const data = await res.json();
      if(data.code !== 200) throw new Error('API error');
      hifzSurahVerses = data.data.ayahs;
      const maxAyah = hifzSurahVerses.length;
      fromAyahInput.max = maxAyah;
      toAyahInput.max = maxAyah;
      toAyahInput.value = maxAyah;
    } catch {
      alert(texts[currentLang].loadError);
    }
  }

  // Load selected ayah range for Hifz test
  function loadSelectedVerses() {
    hifzFeedback.textContent = '';
    recordingStatus.textContent = '';
    startRecitationBtn.disabled = true;

    if (!currentSurahId) {
      alert(texts[currentLang].pleaseLoadSurah);
      return;
    }
    const from = parseInt(fromAyahInput.value, 10);
    const to = parseInt(toAyahInput.value, 10);

    if (from < 1 || to > hifzSurahVerses.length || from > to) {
      alert(texts[currentLang].invalidRange);
      return;
    }

    expectedText = hifzSurahVerses.slice(from - 1, to).map(v => v.text).join(' ');
    hifzFeedback.style.color = 'var(--primary-green)';
    hifzFeedback.textContent = `Recite from Ayah ${from} to ${to}`;
    startRecitationBtn.disabled = false;
  }

  // Start recording for Hifz test
  function startRecording() {
    if (!recognition) {
      setupRecognition();
      if (!recognition) return;
    }
    recognition.start();
    startRecitationBtn.disabled = true;
    stopRecitationBtn.style.display = 'inline-block';
  }

  // Stop recording
  function stopRecording() {
    if (recognition && recognizing) {
      recognition.stop();
    }
  }

  // Event listeners
  startJourneyBtn.onclick = () => {
    showScreen(menuScreen);
  };

  openHifzTestBtn.onclick = () => {
    showScreen(hifzTestScreen);
  };

  toggleDarkBtn.onclick = () => toggleDarkMode();
  menuToggleDarkBtn.onclick = () => toggleDarkMode();

  menuBackBtn.onclick = () => {
    showScreen(startScreen);
  };

  surahBackBtn.onclick = () => {
    if(audioPlayer) {
      audioPlayer.pause();
      audioPlayer = null;
    }
    showScreen(menuScreen);
  };

  toggleTajweedBtn.onclick = () => {
    tajweedEnabled = !tajweedEnabled;
    toggleTajweedBtn.textContent = tajweedEnabled ? (currentLang === 'ar' ? 'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ¨ŸàŸäÿØ' : 'Disable Tajweed') : texts[currentLang].toggleTajweed;
    renderVerses();
  };

  playSurahBtn.onclick = () => {
    if(!currentSurahId) return;
    playSurahAudio();
  };

  reciterSelect.onchange = () => {
    reciter = reciterSelect.value;
  };

  languageSelect.onchange = () => {
    currentLang = languageSelect.value;
    updateLanguageUI();
    renderSurahList();
    renderHifzSurahList();
    if(currentSurahId) {
      openSurahView(currentSurahId, currentSurahName, currentSurahArabicName);
    }
  };

  loadSurahBtn.onclick = loadSelectedVerses;
  startRecitationBtn.onclick = startRecording;
  stopRecitationBtn.onclick = stopRecording;
  hifzBackBtn.onclick = () => showScreen(startScreen);

  // Initialize app
  window.onload = () => {
    updateLanguageUI();
    loadAllSurahs();
    showScreen(startScreen);
    setupRecognition();
  };
</script>

</body>
</html>

