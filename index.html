<!DOCTYPE html>
<html lang="en" class="scroll-smooth" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Quran & Hifz Hub</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-papb8m1PZ/kGAvr5bduXWw7+qY5Io9m98+zaxkFzH+Z48RkJ/v6n4xbozGrk4p5Fp2HJ+kPzM+WZV1YrP17MWA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <!-- Google Fonts Amiri for Arabic -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }
    /* Font family for Arabic */
    .arabic-text {
      font-family: 'Amiri', serif;
      line-height: 1.8;
      direction: rtl;
      user-select: text;
    }
    .blurred-arabic {
      filter: blur(6px);
      user-select: none;
    }
    /* Themes */
    :root {
      --bg: #fefefe;
      --text: #1a202c;
      --accent: #065f46;
      --muted: #4b5563;
      --highlight: #10b981;
      --scrollbar-bg: #d1fae5;
      --scrollbar-thumb: #065f46;
    }
    .dark {
      --bg: #121212;
      --text: #d1d5db;
      --accent: #22c55e;
      --muted: #9ca3af;
      --highlight: #22c55e;
      --scrollbar-bg: #1f2937;
      --scrollbar-thumb: #22c55e;
    }
    .sepia {
      --bg: #f4ecd8;
      --text: #5b4636;
      --accent: #926f34;
      --muted: #7e6b50;
      --highlight: #b5903f;
      --scrollbar-bg: #ddd2b3;
      --scrollbar-thumb: #926f34;
    }
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    ::-webkit-scrollbar-track {
      background: var(--scrollbar-bg);
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 6px;
      border: 3px solid var(--scrollbar-bg);
    }
    /* Modal Background */
    .modal-bg {
      background-color: rgba(0,0,0,0.7);
    }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] text-gray-900 dark:text-gray-300 sepia:text-[#5b4636]" style="--bg:#fff; --text:#111;">
  <div id="app" class="flex-1 flex flex-col max-w-screen-xl mx-auto px-4 md:px-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-center justify-between py-4 border-b border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] sticky top-0 bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] z-40">
      <h1 class="text-3xl font-semibold font-serif text-accent dark:text-green-400 sepia:text-[#926f34] select-none">Pro Quran &amp; Hifz Hub</h1>
      <div class="flex flex-wrap gap-3 mt-3 md:mt-0 items-center">
        <input
          type="search"
          id="searchSurah"
          placeholder="Search Surah by name/number..."
          class="rounded border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-green-400 sepia:focus:ring-[#926f34] bg-white dark:bg-gray-800 sepia:bg-[#f4ecd8] text-gray-900 dark:text-gray-200 sepia:text-[#5b4636] w-56 md:w-72"
          aria-label="Search Surah"
        />
        <select id="translationSelect" aria-label="Select translation" class="rounded border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-green-400 sepia:focus:ring-[#926f34] bg-white dark:bg-gray-800 sepia:bg-[#f4ecd8] text-gray-900 dark:text-gray-200 sepia:text-[#5b4636]">
          <option value="en.asad">English (Asad)</option>
          <option value="en.saheeh">English (Saheeh International)</option>
          <option value="ur.jalandhry">Urdu (Jalandhry)</option>
        </select>
        <button
          id="toggleHifz"
          title="Toggle Hifz Mode (Hide/Blur Arabic)"
          class="btn-primary flex items-center gap-1 px-3 py-2 rounded bg-accent dark:bg-green-600 sepia:bg-[#926f34] text-white hover:bg-green-700 dark:hover:bg-green-700 sepia:hover:bg-[#b5903f] transition"
          aria-pressed="false"
        >
          <i class="fas fa-eye-slash"></i> Hifz Mode
        </button>
        <button
          id="toggleView"
          title="Toggle Mushaf View"
          class="btn-secondary flex items-center gap-1 px-3 py-2 rounded border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] text-accent dark:text-green-400 sepia:text-[#926f34] hover:bg-accent hover:text-white dark:hover:bg-green-600 sepia:hover:bg-[#926f34] transition"
          aria-pressed="false"
        >
          <i class="fas fa-th-large"></i> Mushaf View
        </button>
        <select id="themeSelect" aria-label="Select Theme" class="rounded border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-green-400 sepia:focus:ring-[#926f34] bg-white dark:bg-gray-800 sepia:bg-[#f4ecd8] text-gray-900 dark:text-gray-200 sepia:text-[#5b4636]">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="sepia">Sepia</option>
        </select>
        <label for="fontSizeArabic" class="text-sm text-muted dark:text-gray-400 sepia:text-[#7e6b50]">Arabic Font Size</label>
        <input
          type="range"
          id="fontSizeArabic"
          min="18"
          max="48"
          value="28"
          step="1"
          title="Adjust Arabic font size"
          class="w-24"
        />
      </div>
    </header>

    <main class="flex flex-col md:flex-row flex-1 gap-4 mt-4 mb-24 md:mb-0" role="main">
      <!-- Surah List Panel -->
      <section
        aria-label="Surah List"
        class="md:w-1/4 bg-white dark:bg-gray-800 sepia:bg-[#f9f6ec] border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] rounded-lg overflow-auto max-h-[70vh] md:max-h-[calc(100vh-7rem)] shadow-md"
      >
        <ul id="surahList" class="divide-y divide-gray-300 dark:divide-gray-700 sepia:divide-[#bca85b] text-accent dark:text-green-400 sepia:text-[#926f34] text-lg font-semibold px-2" tabindex="0" role="list">
          <!-- Dynamically Loaded -->
        </ul>
      </section>

      <!-- Reading Area -->
      <section
        id="readingArea"
        class="flex-1 flex flex-col md:flex-row gap-4 bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] rounded-lg border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] shadow-md p-4 overflow-auto max-h-[70vh] md:max-h-[calc(100vh-7rem)]"
        aria-label="Quran Reading Area"
      >
        <!-- Translation Pane -->
        <article
          id="translationPane"
          class="md:w-1/2 overflow-auto pr-2 text-gray-900 dark:text-gray-300 sepia:text-[#5b4636] font-sans"
          tabindex="0"
          aria-live="polite"
          aria-label="Translation Text"
        >
          <!-- Dynamically Loaded Translations -->
        </article>

        <!-- Arabic Pane -->
        <article
          id="arabicPane"
          class="md:w-1/2 overflow-auto pl-2 arabic-text text-2xl md:text-3xl font-serif leading-relaxed"
          tabindex="0"
          aria-live="polite"
          aria-label="Arabic Text"
        >
          <!-- Dynamically Loaded Arabic -->
        </article>
      </section>
    </main>

    <!-- Favorites Tab -->
    <section
      id="favoritesSection"
      class="fixed bottom-20 right-4 w-80 max-h-[50vh] overflow-auto bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] rounded-lg shadow-lg z-50 p-4 hidden"
      aria-label="Favorites"
    >
      <header class="flex justify-between items-center mb-3">
        <h2 class="font-semibold text-xl text-accent dark:text-green-400 sepia:text-[#926f34]">Bookmarks</h2>
        <button
          id="closeFavorites"
          aria-label="Close Bookmarks"
          class="text-gray-500 hover:text-gray-900 dark:hover:text-green-400 sepia:hover:text-[#926f34] transition"
        >
          <i class="fas fa-times"></i>
        </button>
      </header>
      <ul id="favoritesList" class="divide-y divide-gray-300 dark:divide-gray-700 sepia:divide-[#bca85b] max-h-[38vh] overflow-y-auto" role="list">
        <!-- Bookmarked verses -->
      </ul>
      <button
        id="clearFavorites"
        class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white rounded py-2 transition"
        aria-label="Clear All Bookmarks"
      >Clear All</button>
    </section>

    <!-- Tafsir Modal -->
    <div
      id="tafsirModal"
      class="fixed inset-0 flex items-center justify-center modal-bg z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="tafsirTitle"
      aria-describedby="tafsirDesc"
    >
      <div class="bg-white dark:bg-gray-800 sepia:bg-[#f9f6ec] rounded-lg shadow-xl max-w-3xl max-h-[80vh] overflow-y-auto p-6 relative">
        <button
          id="closeTafsir"
          class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 sepia:text-[#926f34] hover:text-gray-900 dark:hover:text-green-400 sepia:hover:text-[#b5903f] transition text-2xl"
          aria-label="Close Tafsir Modal"
        >&times;</button>
        <h3 id="tafsirTitle" class="text-2xl font-semibold mb-4 text-accent dark:text-green-400 sepia:text-[#926f34]"></h3>
        <div id="tafsirDesc" class="prose prose-green dark:prose-invert prose-sepia max-w-none"></div>
      </div>
    </div>

    <!-- Prayer Times Widget -->
    <section
      id="prayerTimesWidget"
      class="fixed top-20 left-4 bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] border border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] rounded-lg shadow-lg p-4 w-64 text-center text-accent dark:text-green-400 sepia:text-[#926f34] z-50 select-none"
      aria-label="Prayer Times Widget"
    >
      <h2 class="font-semibold text-xl mb-2">Next Prayer</h2>
      <p id="prayerName" class="text-2xl font-bold"></p>
      <p id="prayerTime" class="text-lg"></p>
      <p id="prayerCountdown" class="mt-2 font-mono text-gray-600 dark:text-gray-400 sepia:text-[#7e6b50]"></p>
    </section>

    <!-- Daily Goal Tracker -->
    <section
      id="dailyGoalTracker"
      class="fixed bottom-20 left-4 w-24 h-24 z-50"
      aria-label="Daily Quran Reading Goal"
    >
      <svg viewBox="0 0 100 100" class="w-24 h-24">
        <circle
          cx="50"
          cy="50"
          r="45"
          stroke="var(--muted)"
          stroke-width="10"
          fill="none"
        ></circle>
        <circle
          id="dailyGoalProgressCircle"
          cx="50"
          cy="50"
          r="45"
          stroke="var(--highlight)"
          stroke-width="10"
          fill="none"
          stroke-linecap="round"
          stroke-dasharray="282.6"
          stroke-dashoffset="282.6"
          style="transition: stroke-dashoffset 0.4s ease"
        ></circle>
        <text
          id="dailyGoalText"
          x="50"
          y="58"
          text-anchor="middle"
          font-size="20"
          fill="var(--accent)"
          class="dark:fill-green-400 sepia:fill-[#926f34]"
          font-family="Arial, sans-serif"
          >0%</text
        >
      </svg>
      <p class="text-center mt-1 text-xs text-muted dark:text-gray-400 sepia:text-[#7e6b50]">Daily Goal</p>
    </section>

    <!-- Audio Player Bar -->
    <footer
      id="audioPlayerBar"
      class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 sepia:bg-[#f4ecd8] border-t border-gray-300 dark:border-gray-700 sepia:border-[#a8905a] shadow-lg flex items-center gap-4 p-3 z-50"
      role="region"
      aria-label="Quran Audio Player"
    >
      <button
        id="btnPrevVerse"
        aria-label="Previous Verse"
        class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 sepia:hover:bg-[#e5dbb7] transition"
      >
        <i class="fas fa-backward"></i>
      </button>
      <button
        id="btnPlayPause"
        aria-label="Play/Pause"
        class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 sepia:hover:bg-[#e5dbb7] transition text-2xl"
      >
        <i class="fas fa-play"></i>
      </button>
      <button
        id="btnNextVerse"
        aria-label="Next Verse"
        class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 sepia:hover:bg-[#e5dbb7] transition"
      >
        <i class="fas fa-forward"></i>
      </button>
      <div class="flex-1 mx-4 select-none" aria-live="polite" aria-atomic="true">
        <p id="nowPlaying" class="truncate font-semibold text-accent dark:text-green-400 sepia:text-[#926f34]"></p>
      </div>
      <label for="readingModeToggle" class="flex items-center gap-2 cursor-pointer select-none" title="Toggle Reading Mode Auto Scroll">
        <input
          type="checkbox"
          id="readingModeToggle"
          aria-checked="false"
          role="switch"
          class="w-5 h-5 accent-accent dark:accent-green-400 sepia:accent-[#926f34]"
        />
        <span class="text-sm text-muted dark:text-gray-400 sepia:text-[#7e6b50]">Reading Mode</span>
      </label>
    </footer>
  </div>

  <script>
    (() => {
      'use strict';

      // API URLs
      const API_BASE = "https://api.alquran.cloud/v1";
      const audioReciter = "ar.alafasy"; // default reciter (Mishary Alafasy)
      // We could allow reciter switching if desired, but keeping simple here

      // State
      let surahs = [];
      let currentSurah = null;
      let currentAyahIndex = 0;
      let translationsData = {}; // cache for translations per surah + translation code
      let tafsirCache = {}; // cache tafsir per ayah
      let favorites = JSON.parse(localStorage.getItem('pqhh_favorites') || "[]");
      let lastRead = JSON.parse(localStorage.getItem('pqhh_lastRead') || "{}"); // {surah:number, ayah:number}
      let completedSurahs = JSON.parse(localStorage.getItem('pqhh_completedSurahs') || "[]"); // array of surah numbers
      let dailyGoal = 20; // default daily goal in ayahs
      let dailyProgress = JSON.parse(localStorage.getItem('pqhh_dailyProgress') || "{}"); // {date:yyyy-mm-dd, count:number}
      let readingModeActive = false;
      let readingModeScrollInterval = null;
      let fontSizeArabic = 28; // px
      let hifzMode = false;
      let mushafView = false; // false = list, true = mushaf page view
      let theme = 'light';
      let translationCode = 'en.asad';

      // DOM Elements
      const surahListEl = document.getElementById('surahList');
      const translationPane = document.getElementById('translationPane');
      const arabicPane = document.getElementById('arabicPane');
      const searchInput = document.getElementById('searchSurah');
      const translationSelect = document.getElementById('translationSelect');
      const toggleHifzBtn = document.getElementById('toggleHifz');
      const toggleViewBtn = document.getElementById('toggleView');
      const themeSelect = document.getElementById('themeSelect');
      const fontSizeArabicInput = document.getElementById('fontSizeArabic');
      const favoritesSection = document.getElementById('favoritesSection');
      const favoritesList = document.getElementById('favoritesList');
      const closeFavoritesBtn = document.getElementById('closeFavorites');
      const clearFavoritesBtn = document.getElementById('clearFavorites');
      const tafsirModal = document.getElementById('tafsirModal');
      const tafsirTitle = document.getElementById('tafsirTitle');
      const tafsirDesc = document.getElementById('tafsirDesc');
      const closeTafsirBtn = document.getElementById('closeTafsir');
      const prayerTimesWidget = document.getElementById('prayerTimesWidget');
      const prayerNameEl = document.getElementById('prayerName');
      const prayerTimeEl = document.getElementById('prayerTime');
      const prayerCountdownEl = document.getElementById('prayerCountdown');
      const dailyGoalProgressCircle = document.getElementById('dailyGoalProgressCircle');
      const dailyGoalText = document.getElementById('dailyGoalText');
      const btnPlayPause = document.getElementById('btnPlayPause');
      const btnNextVerse = document.getElementById('btnNextVerse');
      const btnPrevVerse = document.getElementById('btnPrevVerse');
      const nowPlayingEl = document.getElementById('nowPlaying');
      const readingModeToggle = document.getElementById('readingModeToggle');

      // Audio
      const audioPlayer = new Audio();
      audioPlayer.preload = "auto";

      // Utility: debounce for search
      function debounce(fn, delay) {
        let timer = null;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(null, args), delay);
        };
      }

      // Util: Format time HH:MM:SS from Date or seconds
      function formatTime(seconds) {
        let d = new Date(seconds * 1000);
        let hh = d.getUTCHours().toString().padStart(2, '0');
        let mm = d.getUTCMinutes().toString().padStart(2, '0');
        let ss = d.getUTCSeconds().toString().padStart(2, '0');
        if (hh === "00") return mm + ":" + ss;
        return hh + ":" + mm + ":" + ss;
      }

      // Util: get today's date string yyyy-mm-dd
      function todayDateString() {
        return new Date().toISOString().split('T')[0];
      }

      // Save state helpers
      function saveFavorites() {
        localStorage.setItem('pqhh_favorites', JSON.stringify(favorites));
      }
      function saveLastRead() {
        localStorage.setItem('pqhh_lastRead', JSON.stringify(lastRead));
      }
      function saveCompletedSurahs() {
        localStorage.setItem('pqhh_completedSurahs', JSON.stringify(completedSurahs));
      }
      function saveDailyProgress() {
        localStorage.setItem('pqhh_dailyProgress', JSON.stringify(dailyProgress));
      }

      // Update Daily Progress
      function updateDailyProgress(ayahCount = 1) {
        const today = todayDateString();
        if (!dailyProgress.date || dailyProgress.date !== today) {
          dailyProgress = { date: today, count: 0 };
        }
        dailyProgress.count = Math.min(dailyGoal, dailyProgress.count + ayahCount);
        saveDailyProgress();
        updateDailyGoalUI();
      }
      // Update Daily Goal Tracker UI
      function updateDailyGoalUI() {
        const pct = Math.round((dailyProgress.count / dailyGoal) * 100);
        const circleLength = 2 * Math.PI * 45; // circumference of circle r=45
        const offset = circleLength - (pct / 100) * circleLength;
        dailyGoalProgressCircle.style.strokeDashoffset = offset;
        dailyGoalText.textContent = `${pct}%`;
      }

      // Apply theme to document.documentElement classList
      function applyTheme(selectedTheme) {
        const htmlEl = document.documentElement;
        htmlEl.classList.remove('dark', 'sepia');
        if (selectedTheme === 'dark') htmlEl.classList.add('dark');
        else if (selectedTheme === 'sepia') htmlEl.classList.add('sepia');
        // CSS variables auto adjust via class
      }

      // Load Surah List from API
      async function loadSurahs() {
        try {
          const res = await fetch(`${API_BASE}/surah`);
          const data = await res.json();
          if (data.code === 200 && data.data) {
            surahs = data.data;
            renderSurahList(surahs);
            // Load last read or first surah by default
            if (lastRead.surah && lastRead.ayah) {
              selectSurah(lastRead.surah - 1, lastRead.ayah - 1);
            } else {
              selectSurah(0, 0);
            }
          } else {
            throw new Error("Failed to load surahs");
          }
        } catch (e) {
          alert("Error loading Surahs: " + e.message);
        }
      }

      // Render Surah List
      function renderSurahList(list) {
        surahListEl.innerHTML = "";
        list.forEach((surah, idx) => {
          const isCompleted = completedSurahs.includes(surah.number);
          const li = document.createElement("li");
          li.setAttribute('role', 'listitem');
          li.tabIndex = 0;
          li.className = `cursor-pointer px-3 py-2 hover:bg-accent hover:text-white dark:hover:bg-green-600 sepia:hover:bg-[#926f34] rounded transition flex justify-between items-center ${isCompleted ? 'bg-accent text-white dark:bg-green-600 sepia:bg-[#926f34]' : ''}`;
          li.textContent = `${surah.number}. ${surah.englishName} (${surah.name})`;
          li.title = surah.englishName + " â€” " + surah.englishNameTranslation;
          li.addEventListener('click', () => selectSurah(idx, 0));
          li.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectSurah(idx, 0);
            }
          });
          surahListEl.appendChild(li);
        });
      }

      // Search Surah input handler
      searchInput.addEventListener('input', debounce((e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) {
          renderSurahList(surahs);
          return;
        }
        let filtered = surahs.filter(s => {
          return s.name.toLowerCase().includes(q) ||
                 s.englishName.toLowerCase().includes(q) ||
                 s.number.toString() === q;
        });
        renderSurahList(filtered);
      }, 250));

      // Select Surah and load its ayahs + translation
      async function selectSurah(index, ayahIndex = 0) {
        if (index < 0 || index >= surahs.length) return;
        currentSurah = surahs[index];
        currentAyahIndex = ayahIndex;
        // Highlight selected surah in list
        [...surahListEl.children].forEach((li, i) => {
          li.classList.toggle('bg-accent', i === index);
          li.classList.toggle('text-white', i === index);
          li.classList.toggle('dark:bg-green-600', i === index);
          li.classList.toggle('sepia:bg-[#926f34]', i === index);
        });

        // Load translation (cache)
        if (!translationsData[currentSurah.number] || !translationsData[currentSurah.number][translationCode]) {
          await loadTranslation(currentSurah.number, translationCode);
        }
        // Render verses
        renderVerses(currentSurah.number);

        // Update audio source and UI
        setupAudioForSurah(currentSurah.number, currentAyahIndex);

        // Save last read
        lastRead = { surah: currentSurah.number, ayah: currentAyahIndex + 1 };
        saveLastRead();
      }

      // Load Translation data for surah
      async function loadTranslation(surahNumber, translation) {
        if (!translationsData[surahNumber]) translationsData[surahNumber] = {};
        try {
          const res = await fetch(`${API_BASE}/surah/${surahNumber}/${translation}`);
          const data = await res.json();
          if (data.code === 200 && data.data) {
            translationsData[surahNumber][translation] = data.data.ayahs;
          } else {
            throw new Error("Failed to load translation");
          }
        } catch (e) {
          alert("Error loading translation: " + e.message);
          translationsData[surahNumber][translation] = [];
        }
      }

      // Render Verses into the panes depending on mushafView or listView
      function renderVerses(surahNumber) {
        const ayahsArabic = currentSurah.ayahs || [];
        // For performance, we fetch Arabic verses from the API when we load the surah first time
        // But Alquran.cloud surah API contains ayahs Arabic, let's use that

        // For Arabic, we use currentSurah.ayahs or fetch if missing
        // But our surahs from /surah endpoint don't have ayahs - must fetch separately
        // So fetch full Arabic surah on first render, cache it in currentSurah.ayahs

        if (!currentSurah.ayahs) {
          // Fetch Arabic Ayahs of currentSurah
          fetch(`${API_BASE}/surah/${surahNumber}/ar.alafasy`).then(r => r.json()).then(data => {
            if (data.code === 200) {
              currentSurah.ayahs = data.data.ayahs;
              _renderVersesInner();
            } else {
              alert("Failed to load Arabic verses");
            }
          });
        } else {
          _renderVersesInner();
        }

        function _renderVersesInner() {
          const arabicAyahs = currentSurah.ayahs;
          const translationAyahs = translationsData[surahNumber][translationCode] || [];

          if (!arabicAyahs.length || !translationAyahs.length) {
            translationPane.innerHTML = "<p class='text-muted dark:text-gray-400 sepia:text-[#7e6b50]'>Unable to load verses at this time.</p>";
            arabicPane.innerHTML = "";
            return;
          }

          // Mushaf view: show one ayah centered with page style
          if (mushafView) {
            const ayahIndex = currentAyahIndex;
            if (ayahIndex >= arabicAyahs.length) return;
            const arabicText = arabicAyahs[ayahIndex].text;
            const translationText = translationAyahs[ayahIndex]?.text || "";

            translationPane.innerHTML = `
              <div tabindex="0" role="region" aria-label="Verse Translation" class="prose max-w-none">
                <p class="mb-3">${escapeHtml(translationText)}</p>
                <div class="flex gap-3">
                  ${renderVerseControls(surahNumber, ayahIndex)}
                </div>
              </div>
            `;
            arabicPane.innerHTML = `
              <div tabindex="0" role="region" aria-label="Verse Arabic Text" class="arabic-text text-center text-4xl font-serif leading-relaxed ${hifzMode ? 'blurred-arabic' : ''}" style="font-size:${fontSizeArabic}px;">
                ${escapeHtml(arabicText)}
              </div>
            `;
          } else {
            // List view: show all ayahs scrollable with bookmarking and tafsir buttons
            const allArabicHTML = [];
            const allTranslationHTML = [];

            for (let i = 0; i < arabicAyahs.length; i++) {
              const ayahNum = arabicAyahs[i].numberInSurah;
              const arabicText = arabicAyahs[i].text;
              const translationText = translationAyahs[i]?.text || "";
              const verseKey = `${surahNumber}_${ayahNum}`;

              // Is bookmarked?
              const isBookmarked = favorites.some(f => f.surah === surahNumber && f.ayah === ayahNum);

              // Verse controls: bookmark, tafsir, copy/share
              const controlsHTML = renderVerseControls(surahNumber, i, isBookmarked);

              allArabicHTML.push(`
                <div
                  tabindex="0"
                  class="verse relative py-2 px-2 border-b border-gray-200 dark:border-gray-700 sepia:border-[#bca85b] cursor-pointer ${hifzMode ? 'blurred-arabic' : ''}"
                  data-ayah="${ayahNum}"
                  style="font-size:${fontSizeArabic}px;"
                  role="region"
                  aria-label="Arabic verse ${ayahNum}"
                >
                  <span class="inline-block mr-2 text-sm font-semibold text-muted dark:text-gray-400 sepia:text-[#7e6b50]">${ayahNum}</span>
                  <span>${escapeHtml(arabicText)}</span>
                  <div class="verse-controls absolute top-2 left-2 flex gap-2 text-muted dark:text-gray-400 sepia:text-[#7e6b50] text-sm opacity-0 hover:opacity-100 transition">
                    ${controlsHTML}
                  </div>
                </div>
              `);
              allTranslationHTML.push(`
                <div tabindex="0" class="verse py-2 px-2 border-b border-gray-200 dark:border-gray-700 sepia:border-[#bca85b]" role="region" aria-label="Translation verse ${ayahNum}">
                  <span class="inline-block mr-1 font-semibold">${ayahNum}</span> ${escapeHtml(translationText)}
                </div>
              `);
            }
            translationPane.innerHTML = allTranslationHTML.join("");
            arabicPane.innerHTML = allArabicHTML.join("");

            // Attach tafsir click handlers
            attachVerseEvents();
          }
        }
      }

      // Escape HTML helper
      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Render verse controls (bookmark, tafsir, copy/share)
      function renderVerseControls(surah, ayahIndex, bookmarked = false) {
        // Surah & ayah number for keys
        const ayahNum = ayahIndex + 1;
        const bookmarkClass = bookmarked ? "text-yellow-400" : "hover:text-yellow-400";
        return `
          <button aria-label="Bookmark verse" data-surah="${surah}" data-ayah="${ayahNum}" class="bookmark-btn ${bookmarkClass}" title="Bookmark verse">
            <i class="fas fa-bookmark"></i>
          </button>
          <button aria-label="Show Tafsir" data-surah="${surah}" data-ayah="${ayahNum}" class="tafsir-btn hover:text-accent dark:hover:text-green-400 sepia:hover:text-[#926f34]" title="Show Tafsir">
            <i class="fas fa-book-open"></i>
          </button>
          <button aria-label="Copy verse with translation" data-surah="${surah}" data-ayah="${ayahNum}" class="copy-btn hover:text-accent dark:hover:text-green-400 sepia:hover:text-[#926f34]" title="Copy verse and translation">
            <i class="fas fa-copy"></i>
          </button>
        `;
      }

      // Attach verse controls event listeners
      function attachVerseEvents() {
        document.querySelectorAll('.bookmark-btn').forEach(btn => {
          btn.onclick = () => {
            const surahNum = +btn.dataset.surah;
            const ayahNum = +btn.dataset.ayah;
            toggleBookmark(surahNum, ayahNum);
            renderVerses(currentSurah.number); // Refresh to update bookmark icon
          };
        });
        document.querySelectorAll('.tafsir-btn').forEach(btn => {
          btn.onclick = () => {
            const surahNum = +btn.dataset.surah;
            const ayahNum = +btn.dataset.ayah;
            showTafsir(surahNum, ayahNum);
          };
        });
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.onclick = () => {
            const surahNum = +btn.dataset.surah;
            const ayahNum = +btn.dataset.ayah;
            copyVerseWithTranslation(surahNum, ayahNum);
          };
        });
        // Verses click to play audio and jump
        document.querySelectorAll('#arabicPane .verse').forEach(div => {
          div.onclick = () => {
            const ayahNum = +div.dataset.ayah;
            playVerse(ayahNum - 1);
          };
        });
      }

      // Toggle bookmark
      function toggleBookmark(surahNum, ayahNum) {
        const idx = favorites.findIndex(f => f.surah === surahNum && f.ayah === ayahNum);
        if (idx >= 0) {
          favorites.splice(idx, 1);
          showToast("Bookmark removed");
        } else {
          favorites.push({ surah: surahNum, ayah: ayahNum });
          showToast("Bookmark added");
        }
        saveFavorites();
        renderFavorites();
      }

      // Render favorites list
      function renderFavorites() {
        if (favorites.length === 0) {
          favoritesList.innerHTML = `<p class="text-center text-muted dark:text-gray-400 sepia:text-[#7e6b50]">No bookmarks yet.</p>`;
          return;
        }
        favoritesList.innerHTML = "";
        favorites.forEach(({ surah, ayah }) => {
          const surahData = surahs.find(s => s.number === surah);
          if (!surahData) return;
          const surahName = surahData.englishName + " (" + surahData.name + ")";
          // Translation text from cache if available
          const translationAyahs = translationsData[surah]?.[translationCode] || [];
          const translationText = translationAyahs[ayah - 1]?.text || "";
          const item = document.createElement("li");
          item.className = "py-2 flex justify-between items-center border-b border-gray-300 dark:border-gray-700 sepia:border-[#bca85b]";
          item.innerHTML = `
            <div>
              <strong>${surahName} - Ayah ${ayah}</strong><br/>
              <small class="text-muted dark:text-gray-400 sepia:text-[#7e6b50]">${escapeHtml(translationText)}</small>
            </div>
            <button aria-label="Remove bookmark" class="text-red-600 hover:text-red-800 dark:hover:text-red-400 sepia:hover:text-[#b34a1e]" data-surah="${surah}" data-ayah="${ayah}">
              <i class="fas fa-trash"></i>
            </button>
          `;
          item.querySelector('button').onclick = e => {
            const s = +e.target.closest('button').dataset.surah;
            const a = +e.target.closest('button').dataset.ayah;
            toggleBookmark(s, a);
          };
          favoritesList.appendChild(item);
        });
      }

      // Show favorites section
      function showFavorites() {
        favoritesSection.classList.remove('hidden');
      }
      // Close favorites section
      closeFavoritesBtn.onclick = () => {
        favoritesSection.classList.add('hidden');
      };
      clearFavoritesBtn.onclick = () => {
        if (confirm("Clear all bookmarks?")) {
          favorites = [];
          saveFavorites();
          renderFavorites();
        }
      };

      // Show Tafsir modal
      async function showTafsir(surahNum, ayahNum) {
        tafsirTitle.textContent = `Tafsir for Surah ${surahNum}, Ayah ${ayahNum}`;
        tafsirDesc.innerHTML = `<p>Loading tafsir...</p>`;
        tafsirModal.classList.remove('hidden');
        // Fetch tafsir: we'll try Ibn Kathir from api.alquran.cloud
        const key = `${surahNum}_${ayahNum}`;
        if (tafsirCache[key]) {
          tafsirDesc.innerHTML = tafsirCache[key];
          return;
        }
        try {
          // Use jalalayn for lighter tafsir, fallback to ibn kathir
          const jalalaynRes = await fetch(`https://api.quran.com/api/v4/tafsirs/19/contents/${surahNum}/${ayahNum}`);
          const jalalaynData = await jalalaynRes.json();
          if (jalalaynData.data && jalalaynData.data.text) {
            tafsirCache[key] = `<p>${escapeHtml(jalalaynData.data.text)}</p>`;
            tafsirDesc.innerHTML = tafsirCache[key];
          } else {
            // fallback to ibn kathir
            const ibnRes = await fetch(`https://api.quran.com/api/v4/tafsirs/1/contents/${surahNum}/${ayahNum}`);
            const ibnData = await ibnRes.json();
            tafsirCache[key] = ibnData.data?.text ? `<p>${escapeHtml(ibnData.data.text)}</p>` : "<p>Tafsir not available.</p>";
            tafsirDesc.innerHTML = tafsirCache[key];
          }
        } catch {
          tafsirDesc.innerHTML = "<p>Error loading tafsir.</p>";
        }
      }

      // Close tafsir modal
      closeTafsirBtn.onclick = () => {
        tafsirModal.classList.add('hidden');
      };
      tafsirModal.onclick = (e) => {
        if (e.target === tafsirModal) {
          tafsirModal.classList.add('hidden');
        }
      };

      // Copy verse with translation to clipboard
      function copyVerseWithTranslation(surahNum, ayahNum) {
        const translationAyahs = translationsData[surahNum]?.[translationCode] || [];
        const translationText = translationAyahs[ayahNum - 1]?.text || "";
        const arabicText = currentSurah.ayahs?.[ayahNum - 1]?.text || "";
        const fullText = `Surah ${surahNum}, Ayah ${ayahNum}\nArabic:\n${arabicText}\n\nTranslation:\n${translationText}`;
        navigator.clipboard.writeText(fullText).then(() => {
          showToast("Copied verse to clipboard");
        }).catch(() => {
          alert("Failed to copy");
        });
      }

      // Toast notifications (simple)
      let toastTimeout;
      function showToast(message) {
        if (toastTimeout) clearTimeout(toastTimeout);
        let toast = document.getElementById('pqhh-toast');
        if (!toast) {
          toast = document.createElement('div');
          toast.id = 'pqhh-toast';
          toast.className = "fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-accent dark:bg-green-600 sepia:bg-[#926f34] text-white px-6 py-3 rounded shadow-lg z-60 text-center select-none";
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.opacity = '1';
        toast.style.transition = 'opacity 0.3s ease';
        toastTimeout = setTimeout(() => {
          toast.style.opacity = '0';
        }, 2000);
      }

      // Audio controls & engine
      let audioQueue = [];
      function setupAudioForSurah(surahNum, startAyahIndex) {
        // Build audioQueue: URLs of each ayah audio in the surah starting at startAyahIndex
        // Alafasy mp3 URLs pattern: https://cdn.islamic.network/quran/audio/128/ar.alafasy/{surahNumber}{ayahNumber}.mp3 (padded)
        audioQueue = [];
        const totalAyahs = currentSurah.ayahs?.length || 0;
        for (let i = startAyahIndex; i < totalAyahs; i++) {
          const surahStr = surahNum.toString().padStart(3, '0');
          const ayahStr = (i + 1).toString().padStart(3, '0');
          audioQueue.push(`https://cdn.islamic.network/quran/audio/128/ar.alafasy/${surahStr}${ayahStr}.mp3`);
        }
        currentAyahIndex = startAyahIndex;
        if (audioQueue.length) {
          audioPlayer.src = audioQueue[0];
          updateNowPlaying();
        }
      }

      // Play current verse audio
      function playCurrentVerse() {
        if (!audioPlayer.src) return;
        audioPlayer.play();
        btnPlayPause.innerHTML = '<i class="fas fa-pause"></i>';
      }
      function pauseAudio() {
        audioPlayer.pause();
        btnPlayPause.innerHTML = '<i class="fas fa-play"></i>';
      }

      // Play verse by index (relative to currentSurah)
      function playVerse(verseIndex) {
        if (!currentSurah || !currentSurah.ayahs) return;
        if (verseIndex < 0) verseIndex = 0;
        if (verseIndex >= currentSurah.ayahs.length) return;
        currentAyahIndex = verseIndex;
        setupAudioForSurah(currentSurah.number, verseIndex);
        playCurrentVerse();
        // Scroll into view (list view only)
        if (!mushafView) {
          const verseEl = arabicPane.querySelector(`.verse[data-ayah="${verseIndex + 1}"]`);
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        // Save last read position
        lastRead = { surah: currentSurah.number, ayah: currentAyahIndex + 1 };
        saveLastRead();
        updateNowPlaying();
        updateCompletedSurahsIfNeeded();
      }

      // Update Now Playing text
      function updateNowPlaying() {
        const ayahNum = currentAyahIndex + 1;
        nowPlayingEl.textContent = `Surah ${currentSurah.englishName} (${currentSurah.name}), Ayah ${ayahNum}`;
      }

      // Audio event handlers
      audioPlayer.onended = () => {
        currentAyahIndex++;
        if (currentAyahIndex >= currentSurah.ayahs.length) {
          // Try next Surah if available
          const nextIndex = surahs.findIndex(s => s.number === currentSurah.number) + 1;
          if (nextIndex < surahs.length) {
            selectSurah(nextIndex, 0);
            playCurrentVerse();
          } else {
            pauseAudio();
          }
        } else {
          setupAudioForSurah(currentSurah.number, currentAyahIndex);
          playCurrentVerse();
          if (!mushafView) {
            const verseEl = arabicPane.querySelector(`.verse[data-ayah="${currentAyahIndex + 1}"]`);
            if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          lastRead = { surah: currentSurah.number, ayah: currentAyahIndex + 1 };
          saveLastRead();
          updateNowPlaying();
          updateCompletedSurahsIfNeeded();
        }
      };

      btnPlayPause.onclick = () => {
        if (audioPlayer.paused) playCurrentVerse();
        else pauseAudio();
      };
      btnNextVerse.onclick = () => {
        playVerse(currentAyahIndex + 1);
      };
      btnPrevVerse.onclick = () => {
        playVerse(currentAyahIndex - 1);
      };

      // Update completed surahs if finished last ayah
      function updateCompletedSurahsIfNeeded() {
        if (currentAyahIndex + 1 >= currentSurah.ayahs.length) {
          if (!completedSurahs.includes(currentSurah.number)) {
            completedSurahs.push(currentSurah.number);
            saveCompletedSurahs();
            renderSurahList(surahs);
            updateDailyProgress(currentSurah.ayahs.length);
          }
        }
      }

      // Toggle Hifz Mode blur
      toggleHifzBtn.onclick = () => {
        hifzMode = !hifzMode;
        toggleHifzBtn.setAttribute('aria-pressed', hifzMode);
        toggleHifzBtn.querySelector('i').className = hifzMode ? 'fas fa-eye' : 'fas fa-eye-slash';
        renderVerses(currentSurah.number);
      };

      // Toggle Mushaf/List View
      toggleViewBtn.onclick = () => {
        mushafView = !mushafView;
        toggleViewBtn.setAttribute('aria-pressed', mushafView);
        toggleViewBtn.querySelector('i').className = mushafView ? 'fas fa-align-justify' : 'fas fa-th-large';
        renderVerses(currentSurah.number);
      };

      // Theme selection
      themeSelect.onchange = () => {
        theme = themeSelect.value;
        applyTheme(theme);
      };

      // Font size arabic
      fontSizeArabicInput.oninput = () => {
        fontSizeArabic = +fontSizeArabicInput.value;
        renderVerses(currentSurah.number);
      };

      // Translation selection
      translationSelect.onchange = async () => {
        translationCode = translationSelect.value;
        // Load translation if not cached
        if (!translationsData[currentSurah.number] || !translationsData[currentSurah.number][translationCode]) {
          await loadTranslation(currentSurah.number, translationCode);
        }
        renderVerses(currentSurah.number);
      };

      // Prayer Times Widget using Geolocation and Aladhan API
      async function loadPrayerTimes() {
        try {
          let lat, lon;
          if (navigator.geolocation) {
            await new Promise((res, rej) => {
              navigator.geolocation.getCurrentPosition(pos => {
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
                res();
              }, () => rej(), {timeout: 10000});
            });
          } else {
            // fallback IP location using ipinfo.io
            const ipRes = await fetch('https://ipinfo.io/json?token=demo'); // demo token
            const ipData = await ipRes.json();
            if (ipData.loc) {
              [lat, lon] = ipData.loc.split(',').map(Number);
            }
          }
          if (!lat || !lon) throw new Error("Unable to get location");
          // Fetch prayer times from Aladhan API
          const today = new Date();
          const dateStr = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
          const prRes = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(today.getTime()/1000)}?latitude=${lat}&longitude=${lon}&method=2`);
          const prData = await prRes.json();
          if (prData.code !== 200) throw new Error("Failed to get prayer times");
          const timings = prData.data.timings;

          // Convert prayer times to Date objects for comparison
          const prayersOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
          const now = new Date();
          let nextPrayerName = null;
          let nextPrayerTime = null;
          for (const prayer of prayersOrder) {
            const [h, m] = timings[prayer].split(':').map(Number);
            let prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
            if (prayerDate < now) {
              prayerDate.setDate(prayerDate.getDate() + 1);
            }
            if (!nextPrayerTime || prayerDate < nextPrayerTime) {
              nextPrayerTime = prayerDate;
              nextPrayerName = prayer;
            }
          }

          // Display
          prayerNameEl.textContent = nextPrayerName;
          prayerTimeEl.textContent = nextPrayerTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
          updatePrayerCountdown(nextPrayerTime);
          // Update countdown every second
          setInterval(() => updatePrayerCountdown(nextPrayerTime), 1000);
        } catch {
          prayerNameEl.textContent = "N/A";
          prayerTimeEl.textContent = "--:--";
          prayerCountdownEl.textContent = "Unable to load prayer times";
        }
      }
      function updatePrayerCountdown(nextPrayerDate) {
        const now = new Date();
        let diff = (nextPrayerDate - now) / 1000; // seconds
        if (diff < 0) diff = 0;
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = Math.floor(diff % 60);
        prayerCountdownEl.textContent = `in ${h > 0 ? h + 'h ' : ''}${m}m ${s}s`;
      }

      // Auto-scroll reading mode
      readingModeToggle.onchange = () => {
        readingModeActive = readingModeToggle.checked;
        if (readingModeActive) {
          startAutoScroll();
        } else {
          stopAutoScroll();
        }
      };
      function startAutoScroll() {
        if (readingModeScrollInterval) clearInterval(readingModeScrollInterval);
        // Scroll by 1px every 50ms if audio playing
        readingModeScrollInterval = setInterval(() => {
          if (!audioPlayer.paused) {
            window.scrollBy(0, 1);
          }
        }, 50);
      }
      function stopAutoScroll() {
        if (readingModeScrollInterval) clearInterval(readingModeScrollInterval);
      }

      // Initialize theme and font size
      function initSettings() {
        const savedTheme = localStorage.getItem('pqhh_theme') || 'light';
        theme = savedTheme;
        themeSelect.value = savedTheme;
        applyTheme(theme);

        const savedFontSize = parseInt(localStorage.getItem('pqhh_fontSizeArabic'));
        if (savedFontSize && savedFontSize >= 18 && savedFontSize <= 48) {
          fontSizeArabic = savedFontSize;
          fontSizeArabicInput.value = savedFontSize;
        }
      }

      // Store theme and font size on change
      themeSelect.addEventListener('change', () => {
        localStorage.setItem('pqhh_theme', themeSelect.value);
      });
      fontSizeArabicInput.addEventListener('change', () => {
        localStorage.setItem('pqhh_fontSizeArabic', fontSizeArabicInput.value);
      });

      // Keyboard shortcuts for audio player
      window.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return;
        switch(e.key) {
          case ' ': // Space: Play/pause
            e.preventDefault();
            if (audioPlayer.paused) playCurrentVerse();
            else pauseAudio();
            break;
          case 'ArrowRight':
            playVerse(currentAyahIndex + 1);
            break;
          case 'ArrowLeft':
            playVerse(currentAyahIndex - 1);
            break;
          case 'b':
            showFavorites();
            break;
          case 'Escape':
            if (!tafsirModal.classList.contains('hidden')) {
              tafsirModal.classList.add('hidden');
            }
            if (!favoritesSection.classList.contains('hidden')) {
              favoritesSection.classList.add('hidden');
            }
            break;
        }
      });

      // Initial Load
      (async () => {
        initSettings();
        await loadSurahs();
        renderFavorites();
        loadPrayerTimes();
        updateDailyGoalUI();
      })();
    })();
  </script>
</body>
</html>
